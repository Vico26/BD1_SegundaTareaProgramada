<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Gestión de Empleados</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 40px;
      background-color: #f4f4f4;
    }

    h1 {
      text-align: center;
      color: #333;
    }

    .container {
      max-width: 1000px;
      margin: auto;
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap.
    }

    .filter-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .filter-group input[type="text"] {
      padding: 10px;
      width: 250px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }

    .filter-group button,
    .insert-button {
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }

    .filter-group button { background-color: #007bff; }
    .insert-button { background-color: #28a745; }
    .logOut-button {
      background-color: #e41553;
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    table thead {
      background-color: #007bff;
      color: white;
    }

    table th, table td {
      padding: 12px;
      text-align: center;
      border: 1px solid #ccc;
    }

    .action-buttons button {
      margin: 2px;
      padding: 6px 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      color: white;
    }

    .consultar { background-color: #17a2b8; }
    .actualizar { background-color: #ffc107; color:#000; }
    .eliminar { background-color: #dc3545; }
    .movimientos { background-color: #6f42c1; }

    .action-buttons button:hover { opacity: 0.8; }

    /* Modal ampliado para cubrir toda la vista */
    .modal{
      display:none;
      position:fixed;
      z-index:1000;
      inset:0;
      background:rgba(0,0,0,0.65);
      justify-content:center;
      align-items:center;
      padding: 20px;
    }
    .modal-content{
      background-color: antiquewhite;
      padding:20px;
      border-radius:8px;
      width:min(900px, 92vw);
      max-height: 85vh;
      overflow:auto;
      text-align: center;
      box-shadow:0 0 10px rgba(0,0,0,0.3);
    }
    .modal-content h3{margin-bottom:20px;}
    .modal-content button{
      padding:10px;
      border:none;
      border-radius:4px;
      background-color:#007bff;
      color:white;
      font-weight:bold;
      cursor:pointer;
    }
    .modal-content .empleado{background-color: #17a2b8;}
    .modal-content .movimiento{background-color: #4388f0;}
    .modal-content .cerrar{background-color: #dc3545; margin-top:10px;}
  </style>
</head>
<body>

  <div class="container">
    <h1>Lista de Empleados</h1>

    <div class="top-bar">
      <div class="filter-group">
        <input type="text" id="filtro" placeholder="Buscar por nombre o documento...">
        <button onclick="filtrarEmpleados()">Filtrar</button>
      </div>
      <button class="insert-button" onclick="abrirModal()">Insertar</button>
      <button class="logOut-button" onclick="logOut()">Cerrar Sesión</button>
    </div>

    <table>
      <thead>
        <tr>
          <th>Valor Documento Identidad</th>
          <th>Nombre</th>
          <th>Puesto</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="tabla-empleados"></tbody>
    </table>
  </div>

  <div id="modalInsertar" class="modal">
    <div class="modal-content">
      <h3>Opciones para insertar:</h3>
      <button class="empleado" onclick="insertarEmpleadoBttn()">Insertar Empleado</button>
      <button class="movimiento" onclick="insertarMovimientoBttn()">Insertar Movimiento</button>
      <button class="cerrar" onclick="cerrarModal()">Cerrar</button>
    </div>
  </div>

  <div id="modalConsultar" class="modal">
    <div class="modal-content" id="consultaContent">
    </div>
  </div>

  <script>
    // Mostrar empleados
    function mostrarEmpleados(lista) {
      const tbody = document.getElementById('tabla-empleados');
      tbody.innerHTML = '';
      lista.forEach(emp => {
        const fila = `
          <tr>
            <td>${emp.ValorDocumentoIdentidad}</td>
            <td>${emp.Nombre}</td>
            <td>${emp.Puesto}</td>
            <td class="action-buttons">
              <button class="consultar" onclick="consultarEmpleado('${emp.ValorDocumentoIdentidad}')">Consultar</button>
              <button class="actualizar" onclick="ActulizarBoton('${emp.ValorDocumentoIdentidad}')">Actualizar</button>
              <button class="eliminar" onclick="eliminarEmpleado('${emp.ValorDocumentoIdentidad}')">Eliminar</button>
              <button class="movimientos">Movimientos</button>
            </td>
          </tr>`;
        tbody.innerHTML += fila;
      });
    }

    // Filtrar empleados
    function filtrarEmpleados() {
      const filtro = document.getElementById('filtro').value.trim().toLowerCase();
      if (!filtro) { mostrarEmpleados(empleados); return; }

      let filtrados = [];
      if (/^[a-zA-Z\s]+$/.test(filtro)) {
        filtrados = empleados.filter(emp => emp.Nombre.toLowerCase().includes(filtro));
      } else if (/^\d+$/.test(filtro)) {
        filtrados = empleados.filter(emp => emp.ValorDocumentoIdentidad.includes(filtro));
      } else {
        alert('Por favor ingresa solo letras o solo números para filtrar.');
        return;
      }
      mostrarEmpleados(filtrados);
    }

    // Modal insertar
    function abrirModal() { document.getElementById('modalInsertar').style.display = 'flex'; }
    function cerrarModal() { document.getElementById('modalInsertar').style.display = 'none'; }

    function insertarEmpleadoBttn(){
      cerrarModal();
      window.open('insertarEmpleado.html','popup','width=600,height=400');
    }
    function insertarMovimientoBttn(){
      cerrarModal();
      window.open('insertarMovimiento.html','popup','width=600,height=400');
    }

    //Ventana de actualización
    function ActulizarBoton(ValorDocumentoIdentidad){
      const ancho = 600;
      const alto = 500;
      const x = (screen.width / 2) - (ancho / 2);
      const y = (screen.height / 2) - (alto / 2);

      const popup = window.open('ActulizarBoton.html', 'ActulizarBoton',
        `width=${ancho},height=${alto},left=${x},top=${y}`);

      popup.onload = () => {
        if (popup && popup.document) {
          const input = popup.document.getElementById('valorDocumentoIdentidad');
          if (input) input.value = ValorDocumentoIdentidad;
        }
      };
    }

    // Logout
    function logOut() {
      const usuario = localStorage.getItem('usuario');
      fetch('/logout', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ Usuario: usuario }),
        credentials: 'include'
      })
      .then(response => {
        if (response.ok) {
          localStorage.removeItem('usuario');
          window.location.href = 'index.html';
        } else {
          alert('Error al cerrar sesión.');
        }
      })
      .catch(error => console.error('Error:', error));
    }

    // Obtener empleados
    async function obtenerEmpleados() {
      try {
        const res= await fetch('/empleados',{
          method:'GET',
          headers:{'Content-Type':'application/json'},
          credentials:'include'
        });
        if(!res.ok) throw new Error('Error al obtener empleados');
        const empleadosData = await res.json();
        window.empleados = empleadosData;
        mostrarEmpleados(empleadosData);
      } catch(err) {
        console.error(err);
      }
    }

    // Consultar empleado
    async function consultarEmpleado(filtro) {
      try {
        const res = await fetch(`/empleados/consultar/${encodeURIComponent(filtro)}`, {
          method: 'GET',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include'
        });

        const data = await res.json();

        if (!res.ok) throw new Error(data.error || 'No se pudo consultar el empleado');

        const emp = Array.isArray(data) ? data[0] : data;

        const modal = document.getElementById('modalConsultar');
        const modalContent = document.getElementById('consultaContent');

        modalContent.innerHTML = `
          <h3>Empleado: ${emp.Nombre}</h3>
          <p><strong>Documento:</strong> ${emp.DocumentoIdentidad}</p>
          <p><strong>Puesto:</strong> ${emp["Nombre del Puesto"]}</p>
          <p><strong>Saldo:</strong> ${emp["Saldo de vacaciones"]?? 'N/A'}</p>
          <button class="cerrar" onclick="document.getElementById('modalConsultar').style.display='none'">Cerrar</button>
        `;
        modal.style.display = 'flex';
      } catch (err) {
        console.error(err);
        alert(err.message);
      }
    }

    async function eliminarEmpleado(ValorDocumentoIdentidad) {
      if (!confirm(`¿Seguro que quieres eliminar al empleado con documento ${ValorDocumentoIdentidad}?`)) return;

      try {
        const res = await fetch(`/empleados/borrar/${ValorDocumentoIdentidad}`, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include'
        });

        const data = await res.json();

        if (!res.ok) {
          throw new Error(data.error || 'No se pudo eliminar el empleado');
        }

        alert('Empleado eliminado correctamente');
        obtenerEmpleados();
      } catch (err) {
        console.error(err);
        alert(err.message);
      }
    }

    // Iniciar
    obtenerEmpleados();

    /* --- Botón "Movimientos" -> modal con info + lista real de movimientos (sin textos de error/estado) --- */
    document.getElementById('tabla-empleados')
      .addEventListener('click', (e) => {
        const btn = e.target.closest('button.movimientos');
        if (!btn) return;

        const row = btn.closest('tr');
        const doc = row?.cells?.[0]?.textContent?.trim();
        const nombre = row?.cells?.[1]?.textContent?.trim();
        const puesto = row?.cells?.[2]?.textContent?.trim();

        if (!doc) {
          // Mantengo esta alerta fuera del bloque Movimientos (no es error del fetch)
          alert('No se pudo determinar el documento del empleado.');
          return;
        }

        const empObj = (window.empleados || []).find(e => String(e.ValorDocumentoIdentidad) === doc);
        const saldo = (empObj && (empObj["Saldo de vacaciones"] ?? empObj.SaldoVacaciones)) || 'N/A';

        const modal = document.getElementById('modalConsultar');
        const modalContent = document.getElementById('consultaContent');

        modalContent.innerHTML = `
          <h3>Movimientos — Empleado seleccionado</h3>
          <table style="width:100%; border-collapse: collapse;">
            <thead>
              <tr>
                <th>Documento</th>
                <th>Nombre</th>
                <th>Puesto</th>
                <th>Saldo Vacaciones</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>${doc}</td>
                <td>${nombre || ''}</td>
                <td>${puesto || ''}</td>
                <td>${saldo}</td>
              </tr>
            </tbody>
          </table>

          <h4 style="margin-top:16px;">Movimientos</h4>
          <div id="movimientos-container" style="min-height:40px; text-align:center; padding:8px;"></div>

          <div style="margin-top:12px;">
            <button class="cerrar" onclick="document.getElementById('modalConsultar').style.display='none'">Cerrar</button>
          </div>
        `;
        modal.style.display = 'flex';

        cargarYRenderizarMovimientos(doc).catch(() => {
          // Silencioso: no mostrar nada
        });
      });

    async function cargarYRenderizarMovimientos(doc) {
      const cont = document.getElementById('movimientos-container');
      if (!cont) return;

      try {
        const res = await fetch(`/empleados/movimientos/${encodeURIComponent(doc)}`, {
          method: 'GET',
          headers: { 'Accept': 'application/json' },
          credentials: 'include',
        });
        const data = await res.json();

        if (!res.ok) {
          // Silencioso: vacío
          cont.innerHTML = '';
          return;
        }

        if (!Array.isArray(data) || data.length === 0) {
          // Silencioso: vacío
          cont.innerHTML = '';
          return;
        }

        cont.innerHTML = crearTablaMovimientosHTML(data);
      } catch {
        // Silencioso: vacío
        cont.innerHTML = '';
      }
    }

    function crearTablaMovimientosHTML(movs) {
      const head = `
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Tipo</th>
            <th>Descripción</th>
            <th>Monto</th>
            <th>Usuario</th>
          </tr>
        </thead>`;

      const rows = movs.map(m => `
        <tr>
          <td>${fmtFecha(m.fecha)}</td>
          <td>${safe(m.tipo)}</td>
          <td>${safe(m.descripcion)}</td>
          <td>${fmtMoneda(m.monto)}</td>
          <td>${safe(m.usuario)}</td>
        </tr>`).join('');

      return `<table style="width:100%; border-collapse: collapse;">${head}<tbody>${rows}</tbody></table>`;
    }

    // Utilidades
    function safe(v){ return v == null ? '' : String(v); }
    function fmtFecha(v){
      try{ const d = new Date(v); return isNaN(d) ? safe(v) : d.toLocaleString(); } catch { return safe(v); }
    }
    function fmtMoneda(v, currency='USD', locale){
      const n = Number(v); return isNaN(n) ? safe(v) : new Intl.NumberFormat(locale, {style:'currency', currency}).format(n);
    }
    /* --- FIN AÑADIDO --- */
  </script>
</body>
</html>
