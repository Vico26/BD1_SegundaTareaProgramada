<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Insertar Empleado</title>
<style>
  * { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
  body { background: linear-gradient(135deg,#6a11cb 0%,#2575fc 100%); min-height:100vh; display:flex; justify-content:center; align-items:center; padding:20px; }
  .container { background-color:white; border-radius:12px; padding:30px; max-width:450px; width:100%; }
  h1 { text-align:center; margin-bottom:30px; color:#333; font-size:24px; font-weight:600; }
  .form-group { margin-bottom:20px; }
  label { display:block; margin-bottom:8px; font-weight:500; color:#555; }
  input, select { width:100%; padding:12px; border:1px solid #ddd; border-radius:6px; font-size:16px; }
  input:focus, select:focus { outline:none; border-color:#4a90e2; box-shadow:0 0 0 2px rgba(74,144,226,0.2); }
  .buttons { display:flex; gap:15px; margin-top:20px; }
  button { flex:1; padding:12px; border:none; border-radius:6px; font-size:16px; font-weight:500; cursor:pointer; }
  .save-btn { background-color:#4a90e2; color:white; }
  .save-btn:hover { background-color:#3a7bc8; }
  .back-btn { background-color:#f5f5f5; color:#333; }
  .back-btn:hover { background-color:#e0e0e0; }
</style>
</head>
<body>

<div class="container">
  <h1>Registrar Empleado</h1>
  <form id="employeeForm">
    <div class="form-group">
      <label for="document">Documento Identidad</label>
      <input type="text" id="document" placeholder="Ingrese documento" required>
    </div>
    <div class="form-group">
      <label for="name">Nombre completo</label>
      <input type="text" id="name" placeholder="Ingrese nombre completo" required>
    </div>
    <div class="form-group">
      <label for="position">Puesto</label>
      <select id="position" required>
        <option value="" disabled selected>Seleccione un puesto</option>
      </select>
    </div>
    <div class="buttons">
      <button type="submit" class="save-btn">Guardar</button>
      <button type="button" class="back-btn" onclick="window.close()">Cancelar</button>
    </div>
  </form>
</div>

<script>
  // Cargar puestos desde el backend
  async function cargarPuestos() {
    const select = document.getElementById('position');
    try {
      const res = await fetch('/puestos', { credentials: 'include' });
      if(!res.ok) throw new Error('Error al cargar puestos: '+res.status);
      const puestos = await res.json();
      select.innerHTML = '<option value="" disabled selected>Seleccione un puesto</option>';
      puestos.forEach(p => {
        const option = document.createElement('option');
        option.value = p.Nombre;
        option.textContent = p.Nombre;
        select.appendChild(option);
      });
    } catch(err) {
      console.error(err);
      select.innerHTML = '<option value="" disabled selected>Error al cargar puestos</option>';
    }
  }

  // Ejecutar al cargar
  document.addEventListener('DOMContentLoaded', cargarPuestos);

  // Manejar formulario
  document.getElementById('employeeForm').addEventListener('submit', async function(e){
    e.preventDefault();

    const valorDocIdenti = document.getElementById('document').value.trim();
    const Nombre = document.getElementById('name').value.trim();
    const NombrePuesto = document.getElementById('position').value;
    const FechaContratacion = new Date().toISOString().split('T')[0]; // hoy

    if(!valorDocIdenti || !Nombre || !NombrePuesto){
      alert('Complete todos los campos');
      return;
    }

    try {
      const res = await fetch('/empleados', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        credentials:'include',
        body: JSON.stringify({ valorDocIdenti, Nombre, NombrePuesto, FechaContratacion })
      });

      const data = await res.json();

      if(!res.ok){
        throw new Error(data.error || 'No se pudo registrar el empleado');
      }

      alert('Empleado registrado correctamente');
      window.opener.obtenerEmpleados(); // refrescar tabla en ventana principal
      window.close(); // cerrar pop-up

    } catch(err) {
      console.error(err);
      alert(err.message);
    }
  });
</script>

</body>
</html>
